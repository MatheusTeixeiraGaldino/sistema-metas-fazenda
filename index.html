<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Metas â€” Fazendas</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Estilos especÃ­ficos das novas funcionalidades */
    .timeline { position: relative; padding-left: 28px; }
    .timeline::before {
      content: ''; position: absolute; left: 8px; top: 0; bottom: 0;
      width: 2px; background: #d0e8d8;
    }
    .timeline-item { position: relative; margin-bottom: 20px; }
    .timeline-dot {
      position: absolute; left: -24px; top: 4px;
      width: 14px; height: 14px; border-radius: 50%;
      background: #2e8b57; border: 2px solid white;
      box-shadow: 0 0 0 2px #2e8b57;
    }
    .timeline-dot.antigo { background: #999; box-shadow: 0 0 0 2px #999; }
    .timeline-card {
      background: white; border-radius: 10px; padding: 14px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    }
    .timeline-card .data { font-size: 12px; color: #888; margin-bottom: 4px; }
    .timeline-card .titulo { font-size: 15px; font-weight: 600; color: #222; }

    .dias-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 8px; margin-top: 10px; }
    .dia-card {
      background: #f8f9fa; border-radius: 8px; padding: 10px;
      text-align: center; font-size: 13px; border: 1px solid #eee;
    }
    .dia-card .dia-data { font-size: 11px; color: #888; margin-bottom: 2px; }
    .dia-card input { 
      width:100%; text-align:center; font-size:18px; font-weight:700;
      border:1px solid #ddd; border-radius:6px; padding:4px;
    }
    .dia-card.sabado input { background: #f0f9f4; }

    .progresso-barra { background: #eee; border-radius: 4px; height: 8px; margin: 8px 0; }
    .progresso-fill { border-radius: 4px; height: 8px; transition: width 0.5s; }
    .progresso-fill.ok  { background: #2e8b57; }
    .progresso-fill.no  { background: #e53e3e; }

    .req-card {
      background: white; border-radius: 10px; padding: 14px 16px;
      margin-bottom: 12px; border-left: 4px solid #ffc107;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    }
    .req-card.aprovada { border-left-color: #2e8b57; }
    .req-card.recusada { border-left-color: #e53e3e; }

    .abas-internas { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
    .aba-interna {
      padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer;
      font-size: 13px; font-weight: 600; border: none;
      background: #e0e0e0; color: #555; transition: all 0.2s;
    }
    .aba-interna.ativa { background: #2e8b57; color: white; }
    .painel-aba { display: none; }
    .painel-aba.ativo { display: block; }

    .colab-header {
      background: white; border-radius: 14px; padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;
      display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;
    }
    .colab-avatar {
      width: 56px; height: 56px; border-radius: 50%;
      background: #2e8b57; display: flex; align-items: center;
      justify-content: center; color: white; font-size: 22px;
    }
    .colab-info { flex: 1; min-width: 200px; }
    .colab-info h3 { margin: 0 0 4px; font-size: 18px; }
    .colab-info p  { margin: 0; font-size: 13px; color: #666; line-height: 1.6; }

    .drop-zone {
      border: 2px dashed #2e8b57; border-radius: 10px; padding: 30px;
      text-align: center; background: #f0f9f4; cursor: pointer;
    }
    .drop-zone:hover { background: #d4edda; }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="tela-login" class="tela ativa">
    <div class="login-box">
      <div class="logo-area">
        <h1>ğŸŒ¾ Sistema de Metas</h1>
        <p>GestÃ£o de Turmas e PremiaÃ§Ã£o</p>
      </div>
      <div class="form-group">
        <label>Chapa</label>
        <input type="text" id="login-chapa" placeholder="Digite sua chapa" />
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="login-senha" placeholder="Digite sua senha" />
      </div>
      <button class="btn-primary" onclick="fazerLogin()">Entrar</button>
      <p id="login-erro" class="erro-msg"></p>
      <hr style="margin:20px 0"/>
      <p style="text-align:center;font-size:13px;color:#666">
        Primeiro acesso? <a href="#" onclick="mostrarCadastro()">Criar conta</a>
      </p>
    </div>
  </div>

  <!-- CADASTRO -->
  <div id="tela-cadastro" class="tela">
    <div class="login-box">
      <h2>ğŸ“‹ Primeiro Acesso</h2>
      <p style="color:#666;font-size:13px;margin-bottom:20px">ApÃ³s o cadastro, aguarde aprovaÃ§Ã£o do administrador.</p>
      <div class="form-group"><label>Chapa</label><input type="text" id="cad-chapa" placeholder="Sua chapa"/></div>
      <div class="form-group"><label>Nome completo</label><input type="text" id="cad-nome" placeholder="Seu nome"/></div>
      <div class="form-group"><label>E-mail</label><input type="email" id="cad-email" placeholder="Seu e-mail"/></div>
      <div class="form-group"><label>Senha (mÃ­n. 6 caracteres)</label><input type="password" id="cad-senha" placeholder="Crie uma senha"/></div>
      <div class="form-group"><label>Confirmar Senha</label><input type="password" id="cad-senha2" placeholder="Repita a senha"/></div>
      <button class="btn-primary" onclick="cadastrarUsuario()">Solicitar Acesso</button>
      <button class="btn-secondary" onclick="mostrarLogin()">â† Voltar ao Login</button>
      <p id="cad-erro" class="erro-msg"></p>
      <p id="cad-ok" class="ok-msg"></p>
    </div>
  </div>

  <!-- SISTEMA PRINCIPAL -->
  <div id="app" class="tela" style="display:none">

    <header class="header">
      <div class="header-left">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <span class="header-title">ğŸŒ¾ Sistema de Metas</span>
      </div>
      <div class="header-right">
        <span id="usuario-nome" class="usuario-info"></span>
        <button class="btn-sair" onclick="sair()">Sair</button>
      </div>
    </header>

    <nav id="menu-lateral" class="menu-lateral fechado">
      <ul>
        <li onclick="irPara('dashboard')">ğŸ“Š Dashboard</li>
        <li onclick="irPara('colaboradores')">ğŸ‘¥ Colaboradores</li>
        <li onclick="irPara('historico-colab')">ğŸ“œ HistÃ³rico de Colaborador</li>
        <li onclick="irPara('turmas')">ğŸ˜ï¸ Turmas</li>
        <li onclick="irPara('fazendas')">ğŸŒ¿ Fazendas</li>
        <li onclick="irPara('metas')">ğŸ¯ Metas e Resultados</li>
        <li onclick="irPara('sabados')">ğŸ“… Controle de SÃ¡bados</li>
        <li onclick="irPara('premiacao')">ğŸ† PremiaÃ§Ã£o</li>
        <li onclick="irPara('exportar')">ğŸ“ Exportar</li>
        <li onclick="irPara('importar-totvs')">ğŸ“¥ Importar Totvs</li>
        <li id="menu-admin" onclick="irPara('admin')" style="display:none">âš™ï¸ AdministraÃ§Ã£o</li>
        <li id="menu-solicit" onclick="irPara('solicitacoes')" style="display:none">ğŸ”” SolicitaÃ§Ãµes</li>
      </ul>
    </nav>

    <main id="conteudo" class="conteudo">

      <!-- DASHBOARD -->
      <section id="pg-dashboard" class="pagina ativa">
        <h2>ğŸ“Š Dashboard</h2>
        <div class="cards-grid">
          <div class="card"><div class="card-num" id="dash-total-turmas">0</div><div class="card-label">Turmas Ativas</div></div>
          <div class="card"><div class="card-num" id="dash-metas-atingidas">0%</div><div class="card-label">Metas Atingidas</div></div>
          <div class="card"><div class="card-num" id="dash-total-colab">0</div><div class="card-label">Colaboradores</div></div>
          <div class="card"><div class="card-num" id="dash-premios">0</div><div class="card-label">PrÃªmios Confirmados</div></div>
        </div>
        <div class="section-box">
          <h3>ğŸ† Ranking de Turmas</h3>
          <div id="ranking-turmas">Carregando...</div>
        </div>
      </section>

      <!-- FAZENDAS -->
      <section id="pg-fazendas" class="pagina">
        <h2>ğŸŒ¿ Fazendas</h2>
        <button class="btn-primary" style="width:auto;margin-bottom:16px" onclick="abrirModalFazenda()">+ Nova Fazenda</button>
        <div id="lista-fazendas" class="lista-cards">Carregando...</div>
      </section>

      <!-- TURMAS -->
      <section id="pg-turmas" class="pagina">
        <h2>ğŸ˜ï¸ Turmas</h2>
        <button class="btn-primary" style="width:auto;margin-bottom:16px" onclick="abrirModalTurma()">+ Nova Turma</button>
        <div class="form-group">
          <label>Filtrar por Fazenda</label>
          <select id="filtro-fazenda-turma" onchange="carregarTurmas()"><option value="">Todas</option></select>
        </div>
        <div id="lista-turmas" class="lista-cards">Carregando...</div>
      </section>

      <!-- COLABORADORES -->
      <section id="pg-colaboradores" class="pagina">
        <h2>ğŸ‘¥ Colaboradores</h2>
        <button class="btn-primary" style="width:auto;margin-bottom:16px" onclick="abrirModalColaborador()">+ Novo Colaborador</button>
        <div class="filtros-linha">
          <select id="filtro-fazenda-colab" onchange="carregarColaboradores()"><option value="">Todas as fazendas</option></select>
          <select id="filtro-turma-colab" onchange="carregarColaboradores()"><option value="">Todas as turmas</option></select>
          <input type="text" id="filtro-nome-colab" placeholder="Buscar nome ou chapa..." oninput="carregarColaboradores()"/>
        </div>
        <div id="lista-colaboradores" class="lista-cards">Carregando...</div>
      </section>

      <!-- HISTÃ“RICO DE COLABORADOR -->
      <section id="pg-historico-colab" class="pagina">
        <h2>ğŸ“œ HistÃ³rico do Colaborador</h2>
        
        <!-- Busca -->
        <div class="section-box">
          <div class="form-group">
            <label>Buscar Colaborador</label>
            <input type="text" id="busca-hist-colab" placeholder="Digite nome ou chapa..." oninput="buscarColabHistorico()"/>
          </div>
          <div id="resultado-busca-hist"></div>
        </div>

        <!-- Perfil do colaborador selecionado -->
        <div id="painel-hist-colab" style="display:none">
          <div class="colab-header">
            <div class="colab-avatar" id="hist-avatar">ğŸ‘¤</div>
            <div class="colab-info">
              <h3 id="hist-nome">â€”</h3>
              <p id="hist-detalhes">â€”</p>
            </div>
            <div id="hist-status-badge"></div>
          </div>

          <!-- SituaÃ§Ã£o atual -->
          <div class="section-box">
            <h3>ğŸ˜ï¸ SituaÃ§Ã£o Atual</h3>
            <div id="hist-situacao-atual">â€”</div>
          </div>

          <!-- Timeline -->
          <div class="section-box">
            <h3>ğŸ“… HistÃ³rico de Turmas</h3>
            <div id="hist-timeline" class="timeline">Carregando...</div>
          </div>

          <!-- Solicitar transferÃªncia (lÃ­der) -->
          <div id="hist-painel-solicitar" style="display:none" class="section-box">
            <h3>ğŸ”„ Solicitar TransferÃªncia</h3>
            <div style="background:#fff8e1;border:1px solid #ffc107;border-radius:10px;padding:16px">
              <p style="font-size:13px;color:#856404;margin-bottom:12px">
                Use quando o colaborador estÃ¡ na sua turma mas deveria estar em outra.
              </p>
              <div class="form-group">
                <label>Turma correta</label>
                <select id="hist-turma-destino" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px">
                  <option value="">Selecione</option>
                </select>
              </div>
              <div class="form-group">
                <label>Data de inÃ­cio na nova turma</label>
                <input type="date" id="hist-data-transf" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
              </div>
              <div class="form-group">
                <label>Motivo</label>
                <textarea id="hist-motivo" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"></textarea>
              </div>
              <button class="btn-primary" style="width:auto" onclick="enviarSolicitacaoTransf()">ğŸ“¤ Enviar SolicitaÃ§Ã£o</button>
              <p id="hist-msg-solicit" class="ok-msg"></p>
            </div>
          </div>

          <!-- HistÃ³rico de solicitaÃ§Ãµes -->
          <div class="section-box">
            <h3>ğŸ“‹ SolicitaÃ§Ãµes de TransferÃªncia</h3>
            <div id="hist-lista-solicit">Nenhuma.</div>
          </div>
        </div>
      </section>

      <!-- METAS E RESULTADOS -->
      <section id="pg-metas" class="pagina">
        <h2>ğŸ¯ Metas e Resultados</h2>

        <!-- Abas internas -->
        <div class="abas-internas">
          <button class="aba-interna ativa" onclick="trocarAbaMetas('lancar')">ğŸ“‹ LanÃ§ar</button>
          <button class="aba-interna" onclick="trocarAbaMetas('importar')" id="aba-importar-meta" style="display:none">ğŸ“¥ Importar Excel</button>
          <button class="aba-interna" onclick="trocarAbaMetas('historico')">ğŸ“Š HistÃ³rico</button>
        </div>

        <!-- Aba: LanÃ§ar -->
        <div id="aba-meta-lancar" class="painel-aba ativo">
          <div class="section-box">
            <h3>Selecionar Turma e Semana</h3>
            <div class="form-group" id="grupo-meta-fazenda"><label>Fazenda</label><select id="meta-fazenda" onchange="carregarTurmasMeta()"><option value="">Selecione</option></select></div>
            <div class="form-group"><label>Turma</label><select id="meta-turma" onchange="carregarSemanasMeta()"><option value="">Selecione</option></select></div>
            <div class="form-group"><label>Semana (Dom â†’ SÃ¡b)</label><select id="meta-semana" onchange="carregarDadosMetaSemana()"><option value="">Selecione</option></select></div>
          </div>

          <div id="painel-meta-semana" style="display:none">
            <!-- Meta da semana -->
            <div class="section-box">
              <h3>ğŸ¯ Meta da Semana</h3>
              <div class="form-group">
                <label>Valor da Meta</label>
                <input type="number" id="meta-valor-semana" placeholder="Ex: 500"/>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn-primary" style="width:auto" onclick="salvarMetaSemana()">ğŸ’¾ Salvar Meta</button>
                <button id="btn-excluir-meta-sem" class="btn-secondary" style="width:auto;color:#e53e3e;display:none" onclick="excluirMetaSemana()">ğŸ—‘ï¸ Excluir</button>
              </div>
              <p id="meta-msg-sem" class="ok-msg"></p>
            </div>

            <!-- Resultados diÃ¡rios -->
            <div class="section-box">
              <h3>ğŸ“… Resultados DiÃ¡rios</h3>
              <p style="font-size:13px;color:#666;margin-bottom:12px">
                Lance o resultado de cada dia. A soma serÃ¡ comparada com a meta.
              </p>
              <div id="meta-dias-grid"></div>
              <button class="btn-primary" style="width:auto;margin-top:12px" onclick="salvarResultadosDias()">ğŸ’¾ Salvar Resultados</button>

              <!-- Resumo -->
              <div style="margin-top:16px;padding:14px;background:#f0f9f4;border-radius:10px">
                <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px">
                  <div><span style="font-size:13px;color:#555">Soma:</span> <strong id="meta-soma-res" style="font-size:20px;color:#2e8b57">0</strong></div>
                  <div><span style="font-size:13px;color:#555">Meta:</span> <strong id="meta-meta-ref" style="font-size:20px;color:#1a5e38">â€”</strong></div>
                  <div id="meta-status-badge"></div>
                </div>
                <div class="progresso-barra"><div class="progresso-fill" id="meta-barra-prog" style="width:0%"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Aba: Importar -->
        <div id="aba-meta-importar" class="painel-aba">
          <div class="section-box">
            <h3>ğŸ“¥ Importar via Excel</h3>
            <div style="background:#f0f9f4;border-radius:8px;padding:12px;margin-bottom:12px;font-size:13px">
              <strong>METAS:</strong> <code>TURMA | SEMANA_INICIO (YYYY-MM-DD) | META</code><br/>
              <strong>RESULTADOS:</strong> <code>TURMA | DATA (YYYY-MM-DD) | RESULTADO</code>
            </div>
            <button class="btn-secondary" style="width:auto;margin-bottom:12px" onclick="baixarModeloMeta()">ğŸ“„ Baixar Modelo</button>
            <div class="form-group">
              <label>Tipo</label>
              <select id="meta-imp-tipo" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px">
                <option value="metas">Importar Metas</option>
                <option value="resultados">Importar Resultados DiÃ¡rios</option>
              </select>
            </div>
            <div class="drop-zone" onclick="document.getElementById('meta-imp-file').click()">
              <p style="color:#2e8b57;font-weight:600;margin:0">ğŸ“‚ Selecionar arquivo Excel</p>
            </div>
            <input type="file" id="meta-imp-file" accept=".xlsx,.xls,.csv" style="display:none" onchange="importarExcelMeta(event)"/>
            <div id="meta-imp-resultado" style="margin-top:12px"></div>
          </div>
        </div>

        <!-- Aba: HistÃ³rico -->
        <div id="aba-meta-historico" class="painel-aba">
          <div class="section-box">
            <div class="filtros-linha">
              <select id="meta-hist-fazenda" onchange="carregarHistoricoMetas()"><option value="">Todas</option></select>
              <select id="meta-hist-turma" onchange="carregarHistoricoMetas()"><option value="">Todas</option></select>
            </div>
          </div>
          <div id="meta-historico-lista">Carregando...</div>
        </div>
      </section>

      <!-- SÃBADOS -->
      <section id="pg-sabados" class="pagina">
        <h2>ğŸ“… Controle de SÃ¡bados</h2>
        <div class="section-box">
          <div class="form-group"><label>Turma</label><select id="sabado-turma" onchange="carregarControleSab()"><option value="">Selecione</option></select></div>
          <div class="form-group"><label>Semana (Dom â†’ SÃ¡b)</label><select id="sabado-semana" onchange="carregarControleSab()"><option value="">Selecione</option></select></div>
        </div>
        <div id="painel-sabado-ctrl" style="display:none" class="section-box">
          <div id="sabado-status-msg" style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px"></div>
          <div id="sabado-lista-colab"></div>
          <button class="btn-primary" style="width:auto;margin-top:12px;display:none" id="btn-salvar-sab" onclick="salvarPresencaSab()">ğŸ’¾ Salvar</button>
        </div>
      </section>

      <!-- PREMIAÃ‡ÃƒO -->
      <section id="pg-premiacao" class="pagina">
        <h2>ğŸ† PremiaÃ§Ã£o</h2>
        <div class="section-box">
          <div class="filtros-linha">
            <select id="premio-fazenda" onchange="filtrarPremiacao()"><option value="">Todas</option></select>
            <select id="premio-semana" onchange="filtrarPremiacao()"><option value="">Todas</option></select>
          </div>
        </div>
        <div class="cards-grid" style="margin-bottom:16px">
          <div class="card" style="grid-column:span 2"><div class="card-num" id="count-conquistaram" style="color:#0056b3">0</div><div class="card-label">Conquistaram</div></div>
          <div class="card" style="grid-column:span 2"><div class="card-num" id="count-trabalharam" style="color:#2e8b57">0</div><div class="card-label">Conquistaram e Trabalharam</div></div>
        </div>
        <div class="section-box">
          <h3 style="color:#0056b3">ğŸ“‹ Lista A â€” Conquistaram</h3>
          <div id="lista-conquistaram">Carregando...</div>
        </div>
        <div class="section-box">
          <h3 style="color:#2e8b57">âœ… Lista B â€” Conquistaram e Trabalharam</h3>
          <div id="lista-trabalharam">Carregando...</div>
        </div>
      </section>

      <!-- EXPORTAR -->
      <section id="pg-exportar" class="pagina">
        <h2>ğŸ“ Exportar</h2>
        <div class="section-box">
          <div class="form-group"><label>Fazenda</label><select id="exp-fazenda"><option value="">Todas</option></select></div>
          <div class="form-group"><label>Semana</label><select id="exp-semana"><option value="">Todas</option></select></div>
          <div class="form-group"><label>Chapa Gerador (6 dÃ­gitos)</label><input type="text" id="exp-chapa-ger" placeholder="000456" maxlength="6"/></div>
          <div class="form-group"><label>Hora InÃ­cio</label><input type="time" id="exp-hi" value="08:00"/></div>
          <div class="form-group"><label>Hora Fim</label><input type="time" id="exp-hf" value="17:00"/></div>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" style="width:auto" onclick="exportarTXT()">ğŸ“„ TXT</button>
            <button class="btn-secondary" style="width:auto" onclick="exportarCSV()">ğŸ“Š CSV</button>
          </div>
          <p id="exp-msg" class="ok-msg"></p>
        </div>
      </section>

      <!-- IMPORTAR TOTVS -->
      <section id="pg-importar-totvs" class="pagina">
        <h2>ğŸ“¥ Importar Colaboradores do Totvs</h2>
        <div class="section-box">
          <p style="font-size:13px;color:#666;margin-bottom:16px">
            Exporte a listagem de colaboradores do Totvs RM em Excel e importe aqui. O sistema detecta mudanÃ§as de turma automaticamente.
          </p>
          <div class="drop-zone" onclick="document.getElementById('totvs-file').click()">
            <p style="color:#2e8b57;font-weight:600;margin:0">ğŸ“‚ Selecionar arquivo Excel do Totvs</p>
            <small style="color:#888">Colunas: CHAPA, NOME, FUNCAO, TURMA, LIDER, ADMISSAO, DEMISSAO, HORAINICIO, HORAFIM</small>
          </div>
          <input type="file" id="totvs-file" accept=".xlsx,.xls,.csv" style="display:none" onchange="importarTotvs(event)"/>
          <div id="totvs-resultado" style="margin-top:16px"></div>
        </div>
      </section>

      <!-- SOLICITAÃ‡Ã•ES (GestÃ£o/Admin) -->
      <section id="pg-solicitacoes" class="pagina">
        <h2>ğŸ”” SolicitaÃ§Ãµes de TransferÃªncia</h2>
        <div class="section-box">
          <h3>â³ Pendentes de AprovaÃ§Ã£o</h3>
          <div id="lista-solicit-pendentes">Carregando...</div>
        </div>
      </section>

      <!-- ADMINISTRAÃ‡ÃƒO -->
      <section id="pg-admin" class="pagina">
        <h2>âš™ï¸ AdministraÃ§Ã£o</h2>
        <div class="section-box">
          <h3>âœ… Aprovar Primeiro Acesso</h3>
          <div id="lista-pendentes">Carregando...</div>
        </div>
        <div class="section-box">
          <h3>ğŸ‘¤ Todos os UsuÃ¡rios</h3>
          <div id="lista-usuarios">Carregando...</div>
        </div>
      </section>

    </main>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal-overlay" style="display:none">
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modal-titulo"></h3>
        <button onclick="fecharModal()" class="btn-fechar">âœ•</button>
      </div>
      <div id="modal-corpo"></div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="fecharModal()">Cancelar</button>
        <button class="btn-primary" id="modal-btn-ok">Salvar</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuz7WznZjMV0Jo5QRZHBSjNIC7XzMNH0A",
      authDomain: "sistema-metas-fazenda.firebaseapp.com",
      projectId: "sistema-metas-fazenda",
      storageBucket: "sistema-metas-fazenda.firebasestorage.app",
      messagingSenderId: "736592211764",
      appId: "1:736592211764:web:2b07e6a79d8571cbae3f61"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    window.auth = auth;
    window.db   = db;
    window.fbFuncs = {
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, onAuthStateChanged,
      collection, doc, addDoc, setDoc, getDoc, getDocs,
      updateDoc, deleteDoc, query, where, orderBy, serverTimestamp
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const snap = await getDoc(doc(db, "usuarios", user.uid));
          if (snap.exists() && snap.data().aprovado) {
            const dados = snap.data();
            window.usuarioLogado = { uid: user.uid, ...dados };
            document.getElementById("usuario-nome").textContent = dados.nome + " (" + dados.perfil + ")";
            if (dados.perfil === "admin") document.getElementById("menu-admin").style.display = "block";
            if (['admin','gestao','encarregado','administrativo'].includes(dados.perfil)) {
              document.getElementById("menu-solicit").style.display = "block";
            }
            mostrarApp();
            carregarDashboard();
            carregarFazendasSelects();
            carregarTurmasCache();
          } else {
            alert("â³ Conta ainda nÃ£o aprovada.");
            await signOut(auth);
            mostrarLogin();
          }
        } catch(e) { mostrarLogin(); }
      } else {
        mostrarLogin();
      }
    });
  </script>
  <script src="app-unificado.js"></script>
</body>
</html>
