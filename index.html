<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Metas â€” Fazendas</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- LOGIN -->
  <div id="tela-login" class="tela ativa">
    <div class="login-box">
      <div class="logo-area">
        <h1>ğŸŒ¾ Sistema de Metas</h1>
        <p>GestÃ£o de Turmas e PremiaÃ§Ã£o</p>
      </div>
      <div class="form-group">
        <label>Chapa</label>
        <input type="text" id="login-chapa" placeholder="Digite sua chapa" />
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="login-senha" placeholder="Digite sua senha" />
      </div>
      <button class="btn-primary" onclick="fazerLogin()">Entrar</button>
      <p id="login-erro" class="erro-msg"></p>
      <hr style="margin:20px 0"/>
      <p style="text-align:center;font-size:13px;color:#666">
        Primeiro acesso? <a href="#" onclick="mostrarCadastro()">Criar conta</a>
      </p>
    </div>
  </div>

  <!-- CADASTRO -->
  <div id="tela-cadastro" class="tela">
    <div class="login-box">
      <h2>ğŸ“‹ Primeiro Acesso</h2>
      <p style="color:#666;font-size:13px;margin-bottom:20px">ApÃ³s o cadastro, aguarde aprovaÃ§Ã£o do administrador.</p>
      <div class="form-group"><label>Chapa</label><input type="text" id="cad-chapa" placeholder="Sua chapa"/></div>
      <div class="form-group"><label>Nome completo</label><input type="text" id="cad-nome" placeholder="Seu nome"/></div>
      <div class="form-group"><label>E-mail</label><input type="email" id="cad-email" placeholder="Seu e-mail"/></div>
      <div class="form-group"><label>Senha (mÃ­n. 6 caracteres)</label><input type="password" id="cad-senha" placeholder="Crie uma senha"/></div>
      <div class="form-group"><label>Confirmar Senha</label><input type="password" id="cad-senha2" placeholder="Repita a senha"/></div>
      <button class="btn-primary" onclick="cadastrarUsuario()">Solicitar Acesso</button>
      <button class="btn-secondary" onclick="mostrarLogin()">â† Voltar ao Login</button>
      <p id="cad-erro" class="erro-msg"></p>
      <p id="cad-ok" class="ok-msg"></p>
    </div>
  </div>

  <!-- SISTEMA PRINCIPAL -->
  <div id="app" class="tela" style="display:none">

    <header class="header">
      <div class="header-left">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <span class="header-title">ğŸŒ¾ Sistema de Metas</span>
      </div>
      <div class="header-right">
        <span id="usuario-nome" class="usuario-info"></span>
        <button class="btn-sair" onclick="sair()">Sair</button>
      </div>
    </header>

    <nav id="menu-lateral" class="menu-lateral fechado">
      <ul>
        <li onclick="irPara('dashboard')">ğŸ“Š Dashboard</li>
        <li onclick="irPara('colaboradores')">ğŸ‘¥ Colaboradores</li>
        <li onclick="irPara('turmas')">ğŸ˜ï¸ Turmas</li>
        <li onclick="irPara('fazendas')">ğŸŒ¿ Fazendas</li>
        <li onclick="irPara('metas')">ğŸ¯ LanÃ§ar Metas</li>
        <li onclick="irPara('sabados')">ğŸ“… Controle de SÃ¡bados</li>
        <li onclick="irPara('premiacao')">ğŸ† PremiaÃ§Ã£o</li>
        <li onclick="irPara('exportar')">ğŸ“ Exportar</li>
        <li id="menu-admin" onclick="irPara('admin')" style="display:none">âš™ï¸ AdministraÃ§Ã£o</li>
      </ul>
    </nav>

    <main id="conteudo" class="conteudo">

      <!-- DASHBOARD -->
      <section id="pg-dashboard" class="pagina ativa">
        <h2>ğŸ“Š Dashboard</h2>
        <div class="cards-grid">
          <div class="card"><div class="card-num" id="dash-total-turmas">0</div><div class="card-label">Turmas Ativas</div></div>
          <div class="card"><div class="card-num" id="dash-metas-atingidas">0%</div><div class="card-label">Metas Atingidas</div></div>
          <div class="card"><div class="card-num" id="dash-total-colab">0</div><div class="card-label">Colaboradores</div></div>
          <div class="card"><div class="card-num" id="dash-premios">0</div><div class="card-label">PrÃªmios Confirmados</div></div>
        </div>
        <div class="section-box">
          <h3>ğŸ† Ranking de Turmas</h3>
          <div id="ranking-turmas">Carregando...</div>
        </div>
      </section>

      <!-- FAZENDAS -->
      <section id="pg-fazendas" class="pagina">
        <h2>ğŸŒ¿ Fazendas</h2>
        <button class="btn-primary" style="width:auto;margin-bottom:16px" onclick="abrirModalFazenda()">+ Nova Fazenda</button>
        <div id="lista-fazendas" class="lista-cards">Carregando...</div>
      </section>

      <!-- TURMAS -->
      <section id="pg-turmas" class="pagina">
        <h2>ğŸ˜ï¸ Turmas</h2>
        <button class="btn-primary" style="width:auto;margin-bottom:16px" onclick="abrirModalTurma()">+ Nova Turma</button>
        <div class="form-group">
          <label>Filtrar por Fazenda</label>
          <select id="filtro-fazenda-turma" onchange="carregarTurmas()"><option value="">Todas</option></select>
        </div>
        <div id="lista-turmas" class="lista-cards">Carregando...</div>
      </section>

      <!-- COLABORADORES -->
      <section id="pg-colaboradores" class="pagina">
        <h2>ğŸ‘¥ Colaboradores</h2>
        <button class="btn-primary" style="width:auto;margin-bottom:16px" onclick="abrirModalColaborador()">+ Novo Colaborador</button>
        <div class="filtros-linha">
          <select id="filtro-fazenda-colab" onchange="carregarColaboradores()"><option value="">Todas as fazendas</option></select>
          <select id="filtro-turma-colab" onchange="carregarColaboradores()"><option value="">Todas as turmas</option></select>
          <input type="text" id="filtro-nome-colab" placeholder="Buscar nome ou chapa..." oninput="carregarColaboradores()"/>
        </div>
        <div id="lista-colaboradores" class="lista-cards">Carregando...</div>
      </section>

      <!-- METAS -->
      <section id="pg-metas" class="pagina">
        <h2>ğŸ¯ LanÃ§ar Metas e Resultados</h2>
        <div class="section-box">
          <h3>Novo LanÃ§amento</h3>

          <div class="form-group">
            <label>ğŸ“… Semana (Domingo â†’ SÃ¡bado)</label>
            <select id="meta-semana" style="font-size:14px">
              <option value="">Selecione a semana</option>
            </select>
            <small style="color:#888;font-size:12px">A premiaÃ§Ã£o serÃ¡ para o sÃ¡bado que finaliza a semana selecionada</small>
          </div>

          <div class="form-group">
            <label>Fazenda</label>
            <select id="meta-fazenda" onchange="carregarTurmasMeta()">
              <option value="">Selecione a fazenda</option>
            </select>
          </div>

          <div class="form-group">
            <label>Turma</label>
            <select id="meta-turma">
              <option value="">Selecione a turma</option>
            </select>
          </div>

          <div class="form-group">
            <label>Meta</label>
            <input type="number" id="meta-valor" placeholder="Ex: 100"/>
          </div>

          <div class="form-group">
            <label>Resultado alcanÃ§ado <span style="color:#888;font-size:12px">(deixe em branco se ainda nÃ£o tem)</span></label>
            <input type="number" id="meta-resultado" placeholder="Ex: 105"/>
          </div>

          <button class="btn-primary" style="width:auto" onclick="lancarMeta()">ğŸ’¾ Salvar</button>
          <p id="meta-msg" class="ok-msg"></p>
        </div>

        <div class="section-box">
          <h3>ğŸ“‹ HistÃ³rico de Metas</h3>
          <div id="lista-metas">Carregando...</div>
        </div>
      </section>

      <!-- SÃBADOS -->
      <section id="pg-sabados" class="pagina">
        <h2>ğŸ“… Controle de SÃ¡bados</h2>
        <div class="section-box">
          <div class="form-group">
            <label>Turma</label>
            <select id="sabado-turma" onchange="carregarControleSabado()">
              <option value="">Selecione a turma</option>
            </select>
          </div>
          <div class="form-group">
            <label>Data do SÃ¡bado</label>
            <input type="date" id="sabado-data" onchange="carregarControleSabado()"/>
            <small style="color:#888;font-size:12px">Selecione apenas sÃ¡bados</small>
          </div>
        </div>

        <div id="painel-sabado" class="section-box" style="display:none">
          <div id="sabado-status" style="margin-bottom:16px;padding:12px;background:#f8f9fa;border-radius:8px;font-size:14px;line-height:1.6"></div>
          <div id="lista-sabado"></div>
          <button class="btn-primary" style="width:auto;margin-top:16px;display:none"
                  id="btn-salvar-presenca" onclick="salvarPresenca()">
            ğŸ’¾ Salvar PresenÃ§as
          </button>
        </div>
      </section>

      <!-- PREMIAÃ‡ÃƒO -->
      <section id="pg-premiacao" class="pagina">
        <h2>ğŸ† PremiaÃ§Ã£o</h2>

        <!-- Filtros -->
        <div class="section-box" style="margin-bottom:16px">
          <div class="filtros-linha">
            <select id="premio-fazenda" onchange="filtrarPremiacao()"><option value="">Todas as fazendas</option></select>
            <select id="premio-semana" onchange="filtrarPremiacao()"><option value="">Todas as semanas</option></select>
          </div>
        </div>

        <!-- Contadores -->
        <div class="cards-grid" style="margin-bottom:16px">
          <div class="card" style="grid-column:span 2">
            <div class="card-num" id="count-conquistaram" style="color:#0056b3">0</div>
            <div class="card-label">Conquistaram o PrÃªmio</div>
          </div>
          <div class="card" style="grid-column:span 2">
            <div class="card-num" id="count-trabalharam" style="color:#2e8b57">0</div>
            <div class="card-label">Conquistaram e Trabalharam no SÃ¡bado</div>
          </div>
        </div>

        <!-- LISTA A -->
        <div class="section-box">
          <h3 style="color:#0056b3">ğŸ“‹ Lista A â€” Conquistaram o PrÃªmio</h3>
          <p style="font-size:13px;color:#666;margin-bottom:12px">
            Todos da turma que atingiu a meta (independente de ter trabalhado no sÃ¡bado)
          </p>
          <div id="lista-conquistaram">Carregando...</div>
        </div>

        <!-- LISTA B -->
        <div class="section-box">
          <h3 style="color:#2e8b57">âœ… Lista B â€” Conquistaram E Trabalharam no SÃ¡bado</h3>
          <p style="font-size:13px;color:#666;margin-bottom:12px">
            Apenas quem a turma ganhou a meta E o lÃ­der confirmou presenÃ§a no sÃ¡bado â€” estes recebem a premiaÃ§Ã£o
          </p>
          <div id="lista-trabalharam">Carregando...</div>
        </div>
      </section>

      <!-- EXPORTAR -->
      <section id="pg-exportar" class="pagina">
        <h2>ğŸ“ Exportar Dados</h2>
        <div class="section-box">
          <h3>Filtros</h3>
          <div class="form-group">
            <label>Fazenda</label>
            <select id="exp-fazenda"><option value="">Todas as fazendas</option></select>
          </div>
          <div class="form-group">
            <label>Semana</label>
            <select id="exp-semana"><option value="">Todas as semanas</option></select>
          </div>
          <div class="form-group">
            <label>Chapa do Gerador (6 dÃ­gitos)</label>
            <input type="text" id="exp-chapa-gerador" placeholder="Ex: 000456" maxlength="6"/>
          </div>
          <div class="form-group">
            <label>Hora InÃ­cio</label>
            <input type="time" id="exp-hora-ini" value="08:00"/>
          </div>
          <div class="form-group">
            <label>Hora Fim</label>
            <input type="time" id="exp-hora-fim" value="17:00"/>
          </div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
            <button class="btn-primary" style="width:auto" onclick="exportarTXT()">ğŸ“„ Exportar TXT</button>
            <button class="btn-secondary" style="width:auto" onclick="exportarCSV()">ğŸ“Š Exportar CSV/Excel</button>
          </div>
          <p id="exp-msg" class="ok-msg"></p>
        </div>

        <div class="section-box" style="background:#f0f9f4;border:1px solid #2e8b57">
          <h3 style="color:#1a5e38">ğŸ“„ Formato do arquivo TXT</h3>
          <p style="font-size:13px;color:#555;line-height:1.8">
            <code>CHAPA;DATA_SABADO;0034;HORA_INICIO;HORA_FIM;0;CHAPA_GERADOR;0;1;1;FOLGA PREMIO</code><br/>
            <strong>Exemplo:</strong> <code>012915;22/02/2026;0034;08:00;17:00;0;000001;0;1;1;FOLGA PREMIO</code><br/>
            <small>Gerado apenas para quem <strong>conquistou E trabalhou no sÃ¡bado</strong> (Lista B)</small>
          </p>
        </div>
      </section>

      <!-- ADMINISTRAÃ‡ÃƒO -->
      <section id="pg-admin" class="pagina">
        <h2>âš™ï¸ AdministraÃ§Ã£o</h2>
        <div class="section-box">
          <h3>âœ… Aprovar Primeiro Acesso</h3>
          <div id="lista-pendentes">Carregando...</div>
        </div>
        <div class="section-box">
          <h3>ğŸ‘¤ Todos os UsuÃ¡rios</h3>
          <div id="lista-usuarios">Carregando...</div>
        </div>
      </section>

    </main>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal-overlay" style="display:none">
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modal-titulo"></h3>
        <button onclick="fecharModal()" class="btn-fechar">âœ•</button>
      </div>
      <div id="modal-corpo"></div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="fecharModal()">Cancelar</button>
        <button class="btn-primary" id="modal-btn-ok">Salvar</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuz7WznZjMV0Jo5QRZHBSjNIC7XzMNH0A",
      authDomain: "sistema-metas-fazenda.firebaseapp.com",
      projectId: "sistema-metas-fazenda",
      storageBucket: "sistema-metas-fazenda.firebasestorage.app",
      messagingSenderId: "736592211764",
      appId: "1:736592211764:web:2b07e6a79d8571cbae3f61"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    window.auth = auth;
    window.db   = db;
    window.fbFuncs = {
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, onAuthStateChanged,
      collection, doc, addDoc, setDoc, getDoc, getDocs,
      updateDoc, deleteDoc, query, where, orderBy, serverTimestamp
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const snap = await getDoc(doc(db, "usuarios", user.uid));
          if (snap.exists() && snap.data().aprovado) {
            const dados = snap.data();
            window.usuarioLogado = { uid: user.uid, ...dados };
            document.getElementById("usuario-nome").textContent = dados.nome + " (" + dados.perfil + ")";
            if (dados.perfil === "admin") document.getElementById("menu-admin").style.display = "block";
            mostrarApp();
            carregarDashboard();
            carregarFazendasSelects();
          } else {
            alert("â³ Conta ainda nÃ£o aprovada.");
            await signOut(auth);
            mostrarLogin();
          }
        } catch(e) { mostrarLogin(); }
      } else {
        mostrarLogin();
      }
    });
  </script>
  <script src="app.js"></script>
</body>
</html>
